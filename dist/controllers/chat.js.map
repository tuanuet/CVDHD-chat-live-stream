{"version":3,"sources":["../../controllers/chat.js"],"names":["TypeRoom","getLiveChat","req","res","render","getCreateLiveChat","postCreateLiveChat","newRoom","name","body","roomName","description","roomDescription","hostId","user","id","type","LIVECHAT","save","err","room","console","log","message","redirect","getLiveChatOnline","roomId","params","getLiveStream","io","rooms","of","adapter","keyRooms","Object","keys","promises","filter","key","startsWith","map","findRoomAndUser","email","value","Promise","all","data","getCreateLiveStream","postCreateLiveStream","LIVESTREAM","getLiveStreamOnline","compareHost","isHost","getLiveStreamSegment","roomAgent","Error","socketIdLiveStream","concat","sockets","socketLiveStream","nsps","connected","countSegment","pathSegment","join","__dirname","segmentStream","createReadStream","pipe"],"mappings":"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","file":"chat.js","sourcesContent":["import Room from '../models/Room';\nimport * as TypeRoom from '../constants/TypeRoom';\nimport _ from 'lodash';\nimport fs from 'fs';\nimport path from 'path';\n\nexport const getLiveChat = (req,res) => {\n  res.render('livechat');\n}\n\n\nexport const getCreateLiveChat = (req,res) => {\n  res.render('livechat/create')\n}\n\nexport const postCreateLiveChat = (req,res) => {\n  let newRoom = new Room({\n    name : req.body.roomName,\n    description : req.body.roomDescription,\n    hostId : req.user.id,\n    type : TypeRoom.LIVECHAT,\n  })\n  newRoom.save((err,room) => {\n    if(err) {\n      console.log(err.message)\n      return;\n    }\n\n    res.redirect(`/livechat/room/${room.id}`);\n  })\n\n}\n\n\n/**\n  * Dungf chung cho 2 route người xem va nguoi host\n  */\nexport const getLiveChatOnline = async (req,res) => {\n  let roomId = req.params.roomId;\n  let user = req.user;\n\n  return res.render('livechat/host',{\n    roomId,user\n  });\n\n};\n\n//===============================================\nexport const getLiveStream = async (req,res) => {\n  let io = req.io;\n  let rooms = io.of('/livestream').adapter.rooms;\n  let keyRooms = Object.keys(rooms);\n  let promises = _(keyRooms)\n      .filter(key => !_(key).startsWith('/livestream'))\n      .map(async roomId => {\n          let room = await Room.findRoomAndUser(roomId);\n          return {\n              roomId,\n              email: room.hostId.email,\n              roomName: room.name,\n              description: room.description\n          }\n      })\n      .value();\n  let data = await Promise.all(promises);\n\n  console.log('room ID:',data);\n  res.render('livestream',{data});\n}\n\nexport const getCreateLiveStream = (req,res) => {\n  res.render('livestream/create')\n}\n\n\nexport const postCreateLiveStream = (req,res) => {\n  let newRoom = new Room({\n    name : req.body.roomName,\n    description : req.body.roomDescription,\n    hostId : req.user.id,\n    type : TypeRoom.LIVESTREAM,\n  })\n  newRoom.save((err,room) => {\n    if(err) {\n      console.log(err.message)\n      return;\n    }\n\n    res.redirect(`/livestream/room/${room.id}`);\n  })\n\n}\n\n/**\n  * Dungf chung cho 2 route người xem va nguoi host\n  */\nexport const getLiveStreamOnline = async (req,res) => {\n  let roomId = req.params.roomId;\n  let user = req.user;\n  console.log(user);\n  //todo: checkdb that user is host ?\n  // if host => render livechat/host\n  // else render livechat/other\n  let isHost = await Room.compareHost(user.id,roomId,TypeRoom.LIVESTREAM);\n\n  if(isHost){\n      return res.render('livestream/host',{roomId,user});\n  }\n  return res.render('livestream/other',{roomId,user});;\n};\n\nexport const getLiveStreamSegment = async (req,res) => {\n  try {\n      let io = req.io;\n      let roomId = req.params.roomId;\n      //todo : find socket have roomId = socket.roomId\n      let roomAgent = io.of('/livestream').adapter.rooms[roomId];\n      if(!roomAgent) throw new Error('room does not exist');\n      let socketIdLiveStream = _.concat([],Object.keys(roomAgent.sockets))[0];\n      let socketLiveStream = io.nsps['/livestream'].connected[socketIdLiveStream];\n      //todo : get segment by count\n      let countSegment = socketLiveStream.countSegment;\n      console.log(countSegment);\n      //todo : read blob segment pip res\n      let pathSegment = path.join(__dirname,`../uploads/${roomId}/blob-${countSegment}.webm`)\n      let segmentStream = fs.createReadStream(pathSegment);\n      // segmentStream = fs.createBlobReadStream(socketLiveStream.buffers.pop())\n      segmentStream.pipe(res);\n\n  } catch (err) {\n      console.log(err.message);\n  }\n\n};"]}